name: Test Install Script

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]
  workflow_dispatch:

jobs:
  test:
    name: Test on ${{ matrix.distro }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu-24.04
            image: ubuntu:24.04
            distro_name: "Ubuntu 24.04 LTS"
            run_as_root: false
          - distro: debian-13
            image: debian:trixie
            distro_name: "Debian 13 (trixie)"
            run_as_root: false
          - distro: fedora-43
            image: fedora:43
            distro_name: "Fedora 43"
            run_as_root: true
          - distro: arch
            image: archlinux:latest
            distro_name: "Arch Linux"
            run_as_root: false
    
    container:
      image: ${{ matrix.image }}
      options: --privileged
    
    steps:
      - name: Install prerequisites
        run: |
          if command -v apt-get &>/dev/null; then
            apt-get update
            apt-get install -y sudo git curl wget ca-certificates
          elif command -v dnf &>/dev/null; then
            dnf install -y git curl wget ca-certificates findutils
          elif command -v pacman &>/dev/null; then
            pacman -Syu --noconfirm
            pacman -S --noconfirm sudo git curl wget ca-certificates base-devel
          fi

      - name: Create test user
        if: ${{ !matrix.run_as_root }}
        run: |
          # Create a test user with sudo privileges
          useradd -m -s /bin/bash testuser
          
          # Set password for the user
          echo "testuser:testpassword" | chpasswd
          
          # Create sudoers file properly using /etc/sudoers.d/
          echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser
          chmod 0440 /etc/sudoers.d/testuser
          
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run install script (as user)
        if: ${{ !matrix.run_as_root }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chown -R testuser:testuser .
          su - testuser -c "export GITHUB_TOKEN='$GITHUB_TOKEN' && cd $(pwd) && bash install.sh"
        shell: bash

      - name: Run install script (as root)
        if: ${{ matrix.run_as_root }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash install.sh
        shell: bash

      - name: Verify installations (as user)
        if: ${{ !matrix.run_as_root }}
        run: |
          su - testuser -c '
            export PATH="$HOME/.local/bin:$HOME/.local/share/go/bin:$HOME/.cargo/bin:$PATH"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            echo "=== Checking installed tools ==="
            fzf --version && rg --version && fd --version && bat --version
            eza --version && glow --version && jaq --version && tmux -V
            rustc --version && cargo --version
            node --version && npm --version
            go version && uv --version
            nvim --version && nu --version && fish --version
            echo "=== All tools verified successfully ==="
          '
        shell: bash

      - name: Verify installations (as root)
        if: ${{ matrix.run_as_root }}
        run: |
          export PATH="$HOME/.local/bin:$HOME/.local/share/go/bin:$HOME/.cargo/bin:$PATH"
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          echo "=== Checking installed tools ==="
          fzf --version && rg --version && fd --version && bat --version
          eza --version && glow --version && jaq --version && tmux -V
          rustc --version && cargo --version
          node --version && npm --version
          go version && uv --version
          nvim --version && nu --version && fish --version
          echo "=== All tools verified successfully ==="
        shell: bash

      - name: Verify configurations (as user)
        if: ${{ !matrix.run_as_root }}
        run: |
          su - testuser -c '
            grep -q ".local/bin" ~/.bashrc
            [ -d ~/.config ] && [ -d ~/.local/bin ] && [ -d ~/.local/share ]
            [ -d ~/.config/nvim ] && [ -d ~/.config/tmux ]
            [ -d ~/.config/nushell ] && [ -d ~/.config/fish ]
            [ -x ~/.local/bin/fzf ] && [ -x ~/.local/bin/rg ]
            [ -x ~/.local/bin/fd ] && [ -x ~/.local/bin/nvim ]
            echo "=== All configurations verified ==="
          '
        shell: bash

      - name: Verify configurations (as root)
        if: ${{ matrix.run_as_root }}
        run: |
          grep -q ".local/bin" ~/.bashrc
          [ -d ~/.config ] && [ -d ~/.local/bin ] && [ -d ~/.local/share ]
          [ -d ~/.config/nvim ] && [ -d ~/.config/tmux ]
          [ -d ~/.config/nushell ] && [ -d ~/.config/fish ]
          [ -x ~/.local/bin/fzf ] && [ -x ~/.local/bin/rg ]
          [ -x ~/.local/bin/fd ] && [ -x ~/.local/bin/nvim ]
          echo "=== All configurations verified ==="
        shell: bash

      - name: Test basic functionality (as user)
        if: ${{ !matrix.run_as_root }}
        run: |
          su - testuser -c '
            export PATH="$HOME/.local/bin:$HOME/.local/share/go/bin:$HOME/.cargo/bin:$PATH"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            echo "test" | fzf -f "test"
            echo "test content" > /tmp/test.txt && rg "test" /tmp/test.txt
            node -e "console.log(\"Hello from Node.js\")"
            rustc --version > /dev/null && go version > /dev/null
            echo "=== Basic functionality tests passed ==="
          '
        shell: bash

      - name: Test basic functionality (as root)
        if: ${{ matrix.run_as_root }}
        run: |
          export PATH="$HOME/.local/bin:$HOME/.local/share/go/bin:$HOME/.cargo/bin:$PATH"
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          echo "test" | fzf -f "test"
          echo "test content" > /tmp/test.txt && rg "test" /tmp/test.txt
          node -e "console.log(\"Hello from Node.js\")"
          rustc --version > /dev/null && go version > /dev/null
          echo "=== Basic functionality tests passed ==="
        shell: bash
